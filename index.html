<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora Detalle</title>

<style>
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:#f2f4f7;
  }
  .app{
    max-width:1200px;
    margin:16px auto;
    padding:16px;
  }
  .card{
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 25px rgba(0,0,0,.08);
    padding:16px;
  }
  h2{margin-top:0}
  table{
    width:100%;
    border-collapse:collapse;
    min-width:900px;
  }
  th,td{
    border-bottom:1px solid #e5e7eb;
    padding:8px;
    text-align:left;
  }
  th{background:#f9fafb}
  select,input{
    width:100%;
    padding:6px;
    border:1px solid #d1d5db;
    border-radius:8px;
  }
  .money{text-align:right}
  button{
    border:none;
    padding:6px 10px;
    border-radius:8px;
    cursor:pointer;
  }
  .add{background:#2563eb;color:#fff}
  .del{background:#fee2e2;color:#b91c1c}
  .totals{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    margin-top:12px;
  }
  .box{
    background:#f9fafb;
    border-radius:12px;
    padding:10px;
    text-align:center;
  }
  .box strong{font-size:1.1rem}
</style>
</head>

<body>
<div class="app">
  <div class="card">
    <h2>Calculadora de Ventas al Detalle</h2>

    <table>
      <thead>
        <tr>
          <th>Marca</th>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>Total</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>

    <button class="add" onclick="agregarFila()">âž• Agregar fila</button>

    <div class="totals">
      <div class="box">
        Total productos<br><strong id="totalU">0</strong>
      </div>
      <div class="box">
        % descuento aplicado<br><strong id="pct">0%</strong>
      </div>
      <div class="box">
        Gran total<br><strong id="gran">â‚¡0</strong>
      </div>
    </div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxhqpaWClFRuTMWWnIEKINEWDJ1a926lVX3wVp0VmSrrxBx5osjsEuUePIiUaZTWBgQ/exec";

let productos=[], marcas=[];

fetch(API,{method:"POST",body:JSON.stringify({action:"productos"})})
.then(r=>r.json())
.then(data=>{
  productos=data;
  marcas=[...new Set(productos.map(p=>p.marca))];
  for(let i=0;i<6;i++) agregarFila();
});

function agregarFila(){
  const tr=document.createElement("tr");

  const m=document.createElement("select");
  m.innerHTML="<option></option>";
  marcas.forEach(x=>m.innerHTML+=`<option>${x}</option>`);

  const p=document.createElement("select");
  p.disabled=true;
  p.innerHTML="<option></option>";

  const q=document.createElement("input");
  q.type="number"; q.min=1; q.value=1;

  const pu=document.createElement("td"); pu.className="money"; pu.textContent="â‚¡0";
  const t=document.createElement("td"); t.className="money"; t.textContent="â‚¡0";

  const d=document.createElement("button");
  d.textContent="ðŸ—‘"; d.className="del";
  d.onclick=()=>{tr.remove();calcular();};

  tr.appendChild(td(m));
  tr.appendChild(td(p));
  tr.appendChild(td(q));
  tr.appendChild(pu);
  tr.appendChild(t);
  tr.appendChild(td(d));

  m.onchange=()=>{
    p.innerHTML="<option></option>";
    p.disabled=!m.value;
    productos.filter(x=>x.marca===m.value)
      .forEach(x=>p.innerHTML+=`<option>${x.nombre}</option>`);
    calcular();
  };
  p.onchange=calcular;
  q.oninput=calcular;

  document.getElementById("body").appendChild(tr);
}

function td(e){const x=document.createElement("td");x.appendChild(e);return x;}

function calcular(){
  const filas=[...document.querySelectorAll("#body tr")].map(tr=>({
    producto: tr.children[1].firstChild.value,
    cantidad: tr.children[2].firstChild.value
  }));

  fetch(API,{method:"POST",body:JSON.stringify({action:"calcularDetalle",items:filas})})
  .then(r=>r.json())
  .then(r=>{
    document.getElementById("totalU").textContent=r.totalUnidades;
    document.getElementById("gran").textContent="â‚¡"+r.granTotal.toLocaleString("es-CR");
    document.getElementById("pct").textContent=r.descuentoPct.toFixed(1)+"%";

    [...document.querySelectorAll("#body tr")].forEach(tr=>{
      const prod=tr.children[1].firstChild.value;
      const qty=tr.children[2].firstChild.value;
      const p=productos.find(x=>x.nombre===prod);
      if(p){
        tr.children[3].textContent="â‚¡"+p.precioLista.toLocaleString("es-CR");
        tr.children[4].textContent="â‚¡"+(p.precioLista*qty).toLocaleString("es-CR");
      }
    });
  });
}
</script>
</body>
</html>
