<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora Detalle</title>

<style>
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:#f2f4f7;
  }
  .app{
    max-width:1200px;
    margin:16px auto;
    padding:16px;
  }
  .card{
    background:#fff;
    border-radius:16px;
    box-shadow:0 10px 25px rgba(0,0,0,.08);
    padding:20px;
  }
  h2{
    margin-top:0;
    background:#2563eb;
    color:#fff;
    padding:14px 20px;
    border-radius:12px;
    text-align:center;
  }
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
  }
  th,td{
    border-bottom:1px solid #e5e7eb;
    padding:10px;
    text-align:left;
  }
  th{
    background:#f9fafb;
    font-weight:600;
  }
  select,input{
    width:100%;
    padding:8px;
    border:1px solid #d1d5db;
    border-radius:10px;
    background:#f3f4f6;
    font-size:15px;
  }
  input[type=number]{
    background:#fff;
    text-align:center;
    font-size:16px;
  }
  .money{
    text-align:right;
    font-weight:500;
  }
  button{
    border:none;
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
  }
  .add{
    margin-top:12px;
    background:#2563eb;
    color:#fff;
  }
  .del{
    background:#fee2e2;
    color:#b91c1c;
  }
  .totals{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:14px;
    margin-top:18px;
  }
  .box{
    background:#f9fafb;
    border-radius:14px;
    padding:14px;
    text-align:center;
  }
  .box strong{
    display:block;
    font-size:1.2rem;
    margin-top:6px;
  }
</style>
</head>

<body>
<div class="app">
  <div class="card">
    <h2>Calculadora de Ventas al Detalle</h2>

    <table>
      <thead>
        <tr>
          <th>Marca</th>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="body"></tbody>
    </table>

    <button class="add" onclick="agregarFila()">Ôºã Agregar fila</button>

    <div class="totals">
      <div class="box">
        Total de productos
        <strong id="totalU">0</strong>
      </div>
      <div class="box">
        Total (sin descuento)
        <strong id="totalSin">‚Ç°0</strong>
      </div>
      <div class="box">
        Total con descuento
        <strong id="gran">‚Ç°0</strong>
      </div>
      <div class="box">
        Descuento aplicado
        <strong id="pct">0%</strong>
      </div>
    </div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxhqpaWClFRuTMWWnIEKINEWDJ1a926lVX3wVp0VmSrrxBx5osjsEuUePIiUaZTWBgQ/exec";

let productos=[], marcas=[];

fetch(API,{
  method:"POST",
  body:JSON.stringify({action:"productos"})
})
.then(r=>r.json())
.then(data=>{
  productos=data;
  marcas=[...new Set(productos.map(p=>p.marca))];
  for(let i=0;i<6;i++) agregarFila();
});

function agregarFila(){
  const tr=document.createElement("tr");

  const marca=document.createElement("select");
  marca.innerHTML="<option value=''></option>";
  marcas.forEach(m=>marca.innerHTML+=`<option>${m}</option>`);

  const producto=document.createElement("select");
  producto.disabled=true;
  producto.innerHTML="<option value=''></option>";

  const cantidad=document.createElement("input");
  cantidad.type="number";
  cantidad.min=0;
  cantidad.max=99;
  cantidad.step=1;
  cantidad.inputMode="numeric";

  const precio=document.createElement("td");
  precio.className="money";
  precio.textContent="‚Ç°0";

  const borrar=document.createElement("button");
  borrar.textContent="üóë";
  borrar.className="del";
  borrar.onclick=()=>{tr.remove();calcular();};

  tr.appendChild(td(marca));
  tr.appendChild(td(producto));
  tr.appendChild(td(cantidad));
  tr.appendChild(precio);
  tr.appendChild(td(borrar));

  let productosMarca=[];

  marca.onchange=()=>{
    producto.innerHTML="<option value=''></option>";
    producto.disabled=!marca.value;
    productosMarca = productos.filter(p=>p.marca===marca.value);
    productosMarca.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.nombre;
      o.textContent=p.nombre;
      producto.appendChild(o);
    });
    calcular();
  };

  producto.oninput=()=>{
    const texto=producto.value.toLowerCase();
    [...producto.options].forEach(o=>{
      if(!o.value) return;
      o.hidden=!o.value.toLowerCase().includes(texto);
    });
    calcular();
  };

  cantidad.oninput=calcular;

  document.getElementById("body").appendChild(tr);
}

function td(el){
  const td=document.createElement("td");
  td.appendChild(el);
  return td;
}

function calcular(){
  const filas=[...document.querySelectorAll("#body tr")].map(tr=>({
    producto: tr.children[1].value,
    cantidad: Number(tr.children[2].value||0)
  }));

  fetch(API,{
    method:"POST",
    body:JSON.stringify({action:"calcularDetalle",items:filas})
  })
  .then(r=>r.json())
  .then(r=>{
    document.getElementById("totalU").textContent=r.totalUnidades;
    document.getElementById("totalSin").textContent=
      "‚Ç°"+r.totalSinDescuento.toLocaleString("es-CR");
    document.getElementById("gran").textContent=
      "‚Ç°"+r.granTotal.toLocaleString("es-CR");
    document.getElementById("pct").textContent=
      r.descuentoPct.toFixed(1)+"%";

    [...document.querySelectorAll("#body tr")].forEach(tr=>{
      const prod=tr.children[1].value;
      const p=productos.find(x=>x.nombre===prod);
      tr.children[3].textContent = p
        ? "‚Ç°"+p.precioLista.toLocaleString("es-CR")
        : "‚Ç°0";
    });
  });
}
</script>
</body>
</html>
