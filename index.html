function descargarResumen(){
  const resumenDiv = document.getElementById("resumen");
  const rb = document.getElementById("resumen-body");

  // Limpiar
  while (rb.firstChild) rb.removeChild(rb.firstChild);

  let productosEncontrados = false;

  document.querySelectorAll("#body tr").forEach(tr => {
    // ✅ Usar nth-child como recomendaste - más robusto
    const selectProducto = tr.querySelector("td:nth-child(2) select");
    const inputCantidad  = tr.querySelector("td:nth-child(3) input");
    const celdaPrecio    = tr.querySelector("td:nth-child(4)");

    if (!selectProducto || !inputCantidad || !celdaPrecio) return;

    const producto = selectProducto.value.trim();
    // ✅ Convertir a número de forma segura
    const cantidad = parseInt(inputCantidad.value, 10) || 0;
    const precioLista = celdaPrecio.textContent.trim();

    // Debug para verificar
    console.log("Procesando:", {producto, cantidad, precioLista});

    if (producto && cantidad > 0) {
      productosEncontrados = true;
      
      const fila = document.createElement("tr");

      const tdProd = document.createElement("td");
      tdProd.textContent = producto;
      tdProd.style.padding = "4px 0";

      const tdCant = document.createElement("td");
      tdCant.textContent = cantidad;
      tdCant.style.textAlign = "center";
      tdCant.style.padding = "4px 0";
      tdCant.style.width = "52px";

      const tdPrecio = document.createElement("td");
      tdPrecio.textContent = precioLista;
      tdPrecio.style.textAlign = "right";
      tdPrecio.style.padding = "4px 0";
      tdPrecio.style.fontWeight = "600";
      tdPrecio.style.width = "110px";

      fila.appendChild(tdProd);
      fila.appendChild(tdCant);
      fila.appendChild(tdPrecio);

      rb.appendChild(fila);
    }
  });

  if (!productosEncontrados) {
    const fila = document.createElement("tr");
    const celda = document.createElement("td");
    celda.colSpan = 3;
    celda.textContent = "No hay productos seleccionados";
    celda.style.textAlign = "center";
    celda.style.padding = "10px";
    fila.appendChild(celda);
    rb.appendChild(fila);
  }

  // Fechas
  const hoy = new Date();
  const vence = new Date();
  vence.setDate(hoy.getDate() + 8);

  document.getElementById("r-fecha").textContent = 
    "Fecha: " + hoy.toLocaleDateString("es-CR");
  document.getElementById("r-vence").textContent = 
    "Válido hasta: " + vence.toLocaleDateString("es-CR");

  // Totales
  document.getElementById("r-total-sin").textContent = 
    document.getElementById("tS").textContent;
  document.getElementById("r-descuento").textContent = 
    document.getElementById("tP").textContent;
  document.getElementById("r-total-final").textContent = 
    document.getElementById("tF").textContent;

  // Esperar a que el DOM se actualice
  setTimeout(() => {
    html2canvas(resumenDiv, {
      scale: 2,
      backgroundColor: "#ffffff",
      logging: false,
      allowTaint: false,
      useCORS: true
    }).then(canvas => {
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "cotizacion_detalle.png";
      a.click();
    }).catch(err => {
      console.error("Error:", err);
      alert("Error al generar la imagen. Revisa la consola (F12).");
    });
  }, 150);
}
