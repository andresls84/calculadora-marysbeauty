<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora Detalle</title>
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #999; padding: 6px; }
  select, input { width: 100%; }
</style>
</head>

<body>

<h3>Calculadora de Ventas al Detalle</h3>

<table>
<thead>
<tr>
<th>Marca</th>
<th>Producto</th>
<th>Cantidad</th>
<th>Precio Unitario</th>
<th>Total</th>
</tr>
</thead>

<tbody id="body"></tbody>

<tfoot>
<tr>
<td colspan="2">Total Productos</td>
<td id="totalU">0</td>
<td>Gran Total</td>
<td id="granT">â‚¡0</td>
</tr>
</tfoot>
</table>

<button onclick="agregarFila()">âž• Agregar fila</button>

<script>
const API = "https://script.google.com/macros/s/AKfycbxhqpaWClFRuTMWWnIEKINEWDJ1a926lVX3wVp0VmSrrxBx5osjsEuUePIiUaZTWBgQ/exec";

let productos = [];
let marcas = [];

// Cargar productos
fetch(API, {
  method: "POST",
  body: JSON.stringify({ action: "productos" })
})
.then(r => r.json())
.then(data => {
  productos = data;

  // ðŸ”´ FILTRAR marcas vacÃ­as (SOLUCIÃ“N)
  marcas = [...new Set(
    productos
      .map(p => p.marca)
      .filter(m => m && m.trim() !== "")
  )];
});

// Agregar fila
function agregarFila() {
  const tr = document.createElement("tr");

  const selMarca = document.createElement("select");
  selMarca.innerHTML = "<option value=''>-- Marca --</option>";
  marcas.forEach(m => {
    const o = document.createElement("option");
    o.value = m;
    o.textContent = m;
    selMarca.appendChild(o);
  });

  const selProd = document.createElement("select");
  selProd.disabled = true;
  selProd.innerHTML = "<option value=''>-- Producto --</option>";

  const qty = document.createElement("input");
  qty.type = "number";
  qty.min = 1;
  qty.value = 1;

  const tdPrecio = document.createElement("td");
  tdPrecio.textContent = "â‚¡0";

  const tdTotal = document.createElement("td");
  tdTotal.textContent = "â‚¡0";

  tr.appendChild(document.createElement("td")).appendChild(selMarca);
  tr.appendChild(document.createElement("td")).appendChild(selProd);
  tr.appendChild(document.createElement("td")).appendChild(qty);
  tr.appendChild(tdPrecio);
  tr.appendChild(tdTotal);

  selMarca.onchange = () => {
    selProd.innerHTML = "<option value=''>-- Producto --</option>";
    selProd.disabled = !selMarca.value;

    productos
      .filter(p => p.marca === selMarca.value)
      .forEach(p => {
        const o = document.createElement("option");
        o.value = p.nombre;
        o.textContent = p.nombre;
        selProd.appendChild(o);
      });

    calcular();
  };

  selProd.onchange = calcular;
  qty.oninput = calcular;

  document.getElementById("body").appendChild(tr);
}

// Calcular
function calcular() {
  const filas = [...document.querySelectorAll("#body tr")].map(tr => ({
    producto: tr.children[1].firstChild.value,
    cantidad: Number(tr.children[2].firstChild.value)
  }));

  fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "calcularDetalle", items: filas })
  })
  .then(r => r.json())
  .then(r => {
    document.getElementById("totalU").textContent = r.totalUnidades;
    document.getElementById("granT").textContent =
      "â‚¡" + r.granTotal.toLocaleString("es-CR");

    r.filas.forEach((f, i) => {
      const tr = document.querySelectorAll("#body tr")[i];
      tr.children[3].textContent =
        "â‚¡" + f.precioUnit.toLocaleString("es-CR");
      tr.children[4].textContent =
        "â‚¡" + f.total.toLocaleString("es-CR");
    });
  });
}
</script>

</body>
</html>
